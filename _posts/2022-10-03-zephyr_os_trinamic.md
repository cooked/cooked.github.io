---
layout: single
title: Trinamic TMCs drivers in Zephyr RTOS
description: Add support for Trinamic TMCs stepper drivers to Zephyr OS

tags: [Zephyr OS, Trinamic, TMC]

header:
    #image: /assets/img/fallback-layout.jpg
    teaser: https://www.allaboutcircuits.com/uploads/articles/TMC5160-stepStick.jpg

excerpt_separator: "<!--more-->"
---

Introduction to the Zephyr RTOS driver for the TMC51xx series of TRINAMIC's motor ICs.

<!--more-->

## State of the art

The driver supports both **SPI and UART** communication protocols. It provides a set of console commands to configure the driver and to run the stepper motor in **velocity or position mode, using the internal ramp generator**.  

### TODOs

- add examples of commands... or make a link to some autogenerated help  
- implement the full Sensor API to set/get driver parameters
- implement step/dir mode

## SPI interface

Interfacing with the TMC via SPI is pretty straightforward.  

Pay attention to limit the maximum speed to 1MHz (TBC!!!)  
{: .notice--warning}  

``` bash
&spi2 {
    cs-gpios = <&gpiob 12 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;

    tmc0: tmc5160@0 {
        compatible = "trinamic,tmc5160";
        status = "okay";
        label = "TMC5160";
        reg = <0x00>;
        spi-max-frequency = <1000000>;
        rotation-distance = <1>;    // [mm/turn]
    };
};
```

## UART interface

``` bash
&usart1 {
    dmas = <&dma1 4 0x440>,
            <&dma1 5 0x480>;
    dma-names = "tx", "rx";
    single-wire;
    pinctrl-0 = <&usart1_tx_pa9>;

    tmc0: tmc5160 {
        compatible = "trinamic,tmc5160";
        status = "okay";
        label = "TMC5160";
    };
};
```

TODO: specify the addressing of slaves (and tell not implemented yet)  

TODO: add Kconfig options

On the ST Nucleo F103RB board the UART2 is used for the consol/debug. Select a different UARTx for the TMC driver.  
{: .notice--warning}  

## Shell commands

NOTE polling  

## Sample applications

### DTS for SPI

### DTS for UART (w/ DMA)


## Development

The project source code is available on [GitHub](https://github.com/cooked/zephyr-trinamic)  

### Workspace
### Project setup
``` bash
cd <repo root>
west init -l manifest
west update
```

TODO: describe the use of the manifest to keep the size small

### Build

## Hardware
TODO: describe the tested (supported) hardware and provide pictures of the wiring

TODO: specify the order of connection (VM first, then VCC_IO) and the cycling of vcc io to reset
- Watterot silentstick (specify that the UART pin are not accessible)
- TMC BOB board
- TMC eval board
- TMC5130 Feedo

